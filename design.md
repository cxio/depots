# depots 详细设计

## 概要

### 数据查询

应用向驿站请求目标数据，传递*类型名称*和*数据标识*。请求会自动携带跳转记录，便于数据的紧缺性感知。


#### 检索

- 驿站先向缓存服务器查询。
- 缓存无结果 => 向内部的目标类型服务查询。
- 内部服务无结果 => 返回通知（未找到）。


#### 储备

如果内部服务未找到数据，驿站可根据数据的紧缺性和自身配置的策略，决定是否向其它驿站请求目标数据。

> **注：**
> 内部服务只负责存储和检索，这样便于集成现有的数据存储技术。


### 数据上传

应用端创建的初始数据需要进入数据网络，因此需要一个把自身数据上传的机制。


#### 探测

应用端首先向网络发送一个目标数据的**探测**包，这是一个简单的请求，无需驿站返回真实的数据。


#### 上传

这个探测会触发驿站的数据紧缺性判定。由此，驿站可能主动请求该数据。此时应用端即可充当数据源节点，将数据上传，完成初始数据的上网储备。


## 数据请求流程

> **前提：**
> 节点需要知道自身NAT的类型，这借助于公共STUN（findings）服务。


### 四个阶段

1. **广播询问**：目标数据的请求一对多逐级转播扩散。**注**：自动适时终止。
2. **传递回复**：应答包原线路回传，多对一逐层消减。**注**：可取2-3个最先收到的响应回传。
3. **请求确认**：应用端和数据提供者直接连系，数据请求确认。
4. **数据传递**：与数据提供节点建立连接，获取数据（可能分片多点传输）。


#### 惰性响应

数据询问在网络中的转播遵循一个简单原则：**惰性响应**。

即收到询问的驿站节点会对数据进行检查，如果发现自身拥有数据，则停止转播，发送回复。如果没有目标数据，则转播该询问。

驿站仅对单个目标数据的哈希执行检查和响应，这个单个的数据可能是一个完整的数据，也可能只是某数据的一个分片（如果询问的只是这个分片的话）。

> **注：**
> 如果节点只是拥有目标数据的部分片段，是否终止转播，由节点自己决定。
> 通常，如果节点拥有大部分片段数据，可能会终止转播，否则回复的同时会续传询问。


### 1. 广播询问

客户端构造数据询问包，向相连的驿站节点发送询问请求。出于隐私保护，数据包不附带询问者的身份或位置信息。


#### 询问包

> **代码格式约定：**
> `(n)` 占用字节数，n bytes。
> `[n]` 占用比特位数，n bits。

```go
(8)     ID：标识本次询问，用于回复包对应源请求。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     类型：询问包
[4]     跳数累计：上限值15，可以是非零起跳。
(1)     公钥算法：应为通用的几种之一，有广泛支持。
(32)    公钥数据：用于回复包加密连系信息。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     NAT层级：
        1) `Pub/FullC`：可直连类型，含通过 UPnP 直接映射到公网。
        2) `RC`：受限圆锥型节点（Restricted Cone）。
        3) `P-RC`：端口受限圆锥型节点（Port Restricted Cone）。
        4) `Sym`：NAT对称型节点（Symmetric NAT）。
[4]     （未用）
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(40)    目标数据索引：
        通常包含数据哈希及数据大小，但由数据拥有者自己解释。
        注：40为上限值。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

询问包为明文未加密，合计最多 `83` 字节长。**注**：节点间为加密通讯，避免第三方窥探。


#### 转播包

节点检查自身是否拥有目标数据。

- **无**：标记该查询，将询问包内*跳数*加一后转播，延续询问……
- **有**：检查彼此NAT层级并创建回复。若因NAT限制两端无法通讯，则视同没有数据。

在询问包的转播扩散过程中，中转节点会记住查询来源，因为回复包需要按原路径逆向返回。


### 2. 传递回复

如果节点拥有目标数据，构建回复包返回。

信息返回按原路径逆向回传，这可以让逐级扩散的询问信息变为逐级收缩，最终恢复为正常的流量。**注**：这也是让询问者可以不必公开自己地址的原因。

如果数据源是受限节点（`RC|P-RC|Sym`），此时只能使用UDP协议，回复包附带打洞协助相关信息：

- 自己的NAT层级。**注**：实际上非必需。
- 自己连接的Findings公网节点。
- 自己连接Findings公网节点的类别（`kind:name`）。

> **注：**
> 任何一方为`Sym`受限节点时，另一方必须为公网类（`Pub/FullC`）节点。
> 数据源节点发送打洞信息前，应确保自己已经连接了共享的Findings公网节点。


#### 回复包

```go
[4]     类型：回复包。
[4]     （未用）
(16)    询问ID：即询问包的ID，用于对应请求源。
(32)    数据源公钥：用于构造共享密钥。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
注：以下信息用共享密钥加密
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     跳数累计：即转播包里的跳数值，可用于距离评估。
[4]     数据源NAT层级：仅UDP适用。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(n...)  - 采用协议：
          应为普遍支持类型，如 Websocket、DTLS或基础TCP/UDP等。
        - 数据地址：
          与协议匹配对应，IP:Port。
        - 打洞信息：
          需要打洞时才有，可选。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(32)    对称密钥：
        如果数据源采用普通TCP或UDP协议，此即有用。可选。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

回复包部分数据加密，长度不定。基础明码长度 `49` 字节。


### 3. 请求确认

询问者收到回复后，用对方的公钥与自己的私钥构建共享密钥，解密回复包内的连系信息。

采用何种方式与数据源节点连接，有以下几种情况：

- 如果数据源为公网类节点（`Pub/FullC`），通常会提供TCP类支持，询问者创建连接即可。
- 如果数据源为受限节点（`RC|P-RC|Sym`），连系信息中应当包含打洞相关信息。借助于Findings节点的定向打洞服务，即可完成。

> **注：**
> 如果数据源为 `Sym` 受限类型，询问者自己必须是 `Pub/FullC` 级别才行。


### 4. 数据传递

与拥有目标数据的节点建立连接后，即可获取所需数据。询问端会向多个连接端发送请求，因此通常也会有多个节点回应。

传递的数据采用与普通 BitTorrent 相似的策略，通常会对大尺寸数据进行分片。


### 数据探测

**数据探测**主要用于完成数据的紧缺性感知。与数据询问不同，探测无需实际的数据返回，即无需回复。

节点行为：检查目标数据，**有即停止，无则转播**。

当然，作为驿站节点本身，在探测包流经节点的过程中，根据数据的紧缺性判定和自身的存储策略，即可决定自己是否需要存储目标数据。


#### 探测包

```go
[4]     类型：探测包
[4]     跳数累计：上限值15。约定：从零起跳
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(36)    目标数据索引：
        通常为数据哈希及数据大小，但由数据拥有者自己解释。
        注：36为上限值。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

探测包为明文未加密数据，合计最多 `37` 字节长。


### 附：文档ID与数据ID

一个大尺寸数据通常采用分片，然后计算各分片的默克尔校验树汇总成一个根哈希，此即为数据ID。它与从文件本身计算的哈希摘要（文档ID）不同。

询问请求里的数据索引应当是针对数据ID，即便该索引可能包含内部的结构。文档ID通常仅在本地校验时有用。
