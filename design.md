# depots 详细设计

## 概要

数据驿站是数据的临时汇聚地，主要负责全网数据的协调和沟通：根据目标数据的紧缺性感知和自身的存储策略，实时调整自己的存储集。

驿站内部需要整合实际的数据服务，比如区块查询或存档检索等。当然，整合的服务实际上也可以是一种纯粹的服务，比如聊天，数据ID在这里只是一个入口标识。

数据服务的收益地址通常由服务自身发送，驿站只是一个联络者，根据请求的ID提供目标的连系信息而已。


### 数据查询

应用向数据驿站请求目标数据，传递全网唯一性**数据标识**。请求包含跳转记录，便于数据的紧缺性感知。


#### 检索

- 驿站解析数据标识，获取数据类别和ID。
- 按类别向内部数据服务器查询目标数据（可能先查询缓存器）。
- 查询数据无结果 => 修改查询数据包（跳转数+1）=> 转播。


#### 储备

如果内部服务未找到数据，驿站可根据数据的紧缺性和自身配置的策略，决定是否向其它驿站请求目标数据。

> **注：**
> 内部服务只负责存储和检索，这样便于集成现有的数据存储技术。


### 数据上传

应用端创建的初始数据需要进入数据网络，因此需要一个把自身数据上传的机制。


#### 探测

应用端首先向网络发送一个目标数据的**探测**包，这是一个简单的请求，无需驿站返回真实的数据。


#### 上传

这个探测会触发驿站的数据紧缺性判定。由此，驿站可能主动请求该数据。此时应用端即可充当数据源节点，将数据上传，完成初始数据的上网储备。



## 数据请求流程

> **前提：**
> 节点需要知道自身NAT的类型，这借助于公共STUN（findings）服务。


### 四个阶段

1. **广播询问**：目标数据的请求一对多逐级转播扩散。**注**：自动适时终止。
2. **传递回复**：应答包原线路回传，多对一逐层消减。**注**：可取2-3个最先收到的响应回传。
3. **请求确认**：应用端和数据提供者直接连系，数据请求确认。
4. **数据传递**：与数据提供节点建立连接，获取数据（可能分片多点传输）。


#### 惰性响应

数据询问在网络中的转播遵循一个简单原则：**惰性响应**。

即收到询问的驿站节点会对数据进行检查，如果发现自身拥有数据，则停止转播，发送回复。如果没有目标数据，则转播该询问。

驿站仅对单个目标数据的哈希执行检查和响应，这个单个的数据可能是一个完整的数据，也可能只是某数据的一个分片（如果询问的只是这个分片的话）。

> **注：**
> 如果节点只是拥有目标数据的部分片段，是否终止转播，由节点自己决定。
> 通常，如果节点拥有大部分片段数据，可能会终止转播，否则回复的同时会续传询问。


### 1. 广播询问

客户端构造数据询问包，向相连的驿站节点发送询问请求。出于隐私保护，数据包不附带询问者的身份或位置信息。


#### 询问包

代码格式约定

```go
> `(n)` 占用字节数，即 n bytes。
> `[n]` 占用比特位数，即 n bits。
```

下面的字节数和比特位数只是一个逻辑值，具体的占用与通讯协议及数据包格式有关。

> **注：**
> 代码实现可能采用 ProtoBuf 数据封装协议。

```go
(4)     Ver：版本号。
(8)     ID： 标识本次询问，用于回复包对应源请求。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     跳数累计：上限值15，可以是非零起跳。
[4]     公钥算法：默认 X25519。最多支持16种。
(32+)   公钥数据：用于回复包加密连系信息。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     NAT 层级：
        1) `Pub/FullC`：可直连类型，含通过 UPnP 直接映射到公网。
        2) `RC`：受限圆锥型节点（Restricted Cone）。
        3) `P-RC`：端口受限圆锥型节点（Port Restricted Cone）。
        4) `Sym`：NAT对称型节点（Symmetric NAT）。
[4]     （未用）
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(1)     数据类别：
        主要用于隔离不同数据采用的不同服务。
        当类别为隐秘的用户定制区时，依靠后续的数据索引区分，可能为服务而非数据。
        0 ~ 0x7F 系统保留区：
        - 存档类：只是简单的检索获取。
        - 区块链：提供交易信息服务，比如检索一笔交易或某个区块。
        - ……
        0x80 ~ 0xFF 用户定制区：
        - 任意类型，由应用私下自行约定，隐秘性。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(32)    数据索引：
        通常为数据的哈希摘要，但也可由用户自己定义和解释。
        注：32为上限值。
(4)     数据大小：
        按字节计数的数据尺寸，可选。
        零值表示忽略、未知或无定义（比如提供的是一个服务）。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

询问包为明文未加密，合计最多 `83+` 字节长。**注**：节点间为加密通讯，避免第三方窥探。


#### 转播包

节点检查自身是否拥有目标数据。

- **无**：标记该查询，将询问包内*跳数*加一后转播，延续询问……
- **有**：检查彼此NAT层级并创建回复。若因NAT限制两端无法通讯，则视同没有数据。

在询问包的转播扩散过程中，中转节点会记住查询来源，因为回复包需要按原路径逆向返回。


### 2. 传递回复

如果节点拥有目标数据，构建回复包返回。

信息返回按原路径逆向回传，这可以让逐级扩散的询问信息变为逐级收缩，最终恢复为正常的流量。**注**：这也是让询问者可以不必公开自己地址的原因。

如果数据源是受限节点（`RC|P-RC|Sym`），此时只能使用UDP协议，回复包附带打洞协助相关信息：

- 自己的NAT层级。**注**：实际上非必需。
- 自己连接的Findings公网节点。
- 自己连接Findings公网节点的类别（`kind:name`）。

> **注：**
> 任何一方为`Sym`受限节点时，另一方必须为公网类（`Pub/FullC`）节点。
> 数据源节点发送打洞信息前，应确保自己已经连接了共享的Findings公网节点。


#### 回复包

```go
(4)     Ver：版本号。
(8)     询问ID：原询问包ID，用于对应请求源。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(32+)   公钥数据：
        数据源的公钥，用于询问端构造共享密钥。算法与询问包相同。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
注：以下信息用共享密钥加密
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     跳数累计：
        到数据源时的跳数，加密避免修改，可用于距离评估。
[4]     NAT 层级：
        数据源节点的信息，仅UDP适用。可选
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(n)     - 协议：
          顶层封装名： websocket|dtls，或 tcp|udp（未封装）
          如果为UDP类，则上面NAT层级信息有效。
        - 数据地址：
          与协议对应，IP:Port。
        - 打洞辅助：
          Findings节点地址、数据节点类名（kind:name）。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

回复包部分数据加密，长度不定。基础明码长度 `44+` 字节。


### 3. 请求确认

询问者收到回复后，用对方的公钥与自己的私钥构建共享密钥，解密回复包内的连系信息。

采用何种方式与数据源节点连接，有以下几种情况：

- 如果数据源为公网类节点（`Pub/FullC`）。通常会提供TCP类支持，询问者连接请求即可。
- 如果数据源为受限节点（`RC|P-RC|Sym`）。连系信息中包含打洞相关信息，借助于Findings节点定向打洞服务即可。

> **注：**
> 如果数据源为 `Sym` 受限类型，询问者自己必须是 `Pub/FullC` 级别才行。


### 4. 数据传递

与拥有目标数据的节点建立连接后，即可获取所需数据。询问端会向多个连接端发送请求，因此通常也会有多个节点回应。

传递大文档数据时，通常采用类似 BitTorrent 的策略，会对大尺寸数据进行分片。


### 数据探测

**数据探测**主要用于完成数据的紧缺性感知。与数据询问不同，探测无需实际的数据返回，即无需回复。

节点行为：检查目标数据，**有即停止，无则转播**。

当然，作为驿站节点本身，在探测包流经节点的过程中，根据数据的紧缺性判定和自身的存储策略，即可决定自己是否需要存储目标数据。


#### 探测包

```go
(4)     Ver：版本号
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     跳数累计：上限值15。约定：从零起跳
[4]     签名算法：最多可表示16种。
(n)     签名公钥：与上面的算法对应。
(n)     签名数据：用于公认的权威数据心跳节点识别。
        注：
        签名部分为可选。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(1)     数据类别：
        与查询包相同规范。
(32)    数据索引：
        通常为数据的哈希摘要，但也可由用户自己定义和解释。
(4)     数据大小：
        按字节计数的数据尺寸，零值表示未知。可选。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

探测包为明文未加密数据，合计最多 `42+签名数据` 字节长。


### 附：文档ID与数据ID

一个大尺寸数据通常采用分片，然后计算各分片的默克尔校验树汇总成一个根哈希，此即为数据ID。它与从文件本身计算的哈希摘要（文档ID）不同。

询问请求里的数据索引应当是针对数据ID，即便该索引可能包含内部的结构。文档ID通常仅在本地校验时有用。



## 数据存储策略

### 策略函数集

不同的策略函数之间是“or”的关系，即任何一项满足即可。


### 白名单与黑名单
