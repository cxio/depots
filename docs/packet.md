# 数据包

## 数据请求流程

> **前提：**
> 节点需要知道自身NAT的类型，这可借助于Findings网络的STUN服务。


### 三个阶段

1. **广播询问**：目标数据的请求一对多逐级扩散。**注**：自动适时终止。
2. **回复确认**：应答包原路回传，多对一逐层消减，避免响应风暴。
3. **数据传输**：应用端和数据提供者建立联系，获取数据（可能分片多点传输）。


### 懒原则

数据询问在网络中的转播遵循简单的懒原则：*有即终止，无才转播*。



## 1. 广播询问

客户端构造数据询问包，向相连的驿站节点发送询问请求。出于隐私保护，数据包设计不附带询问者的位置信息（IP）。

**代码格式约定**

```go
> `(n)` 占用字节数，即 n bytes。
> `[n]` 占用比特位数，即 n bits。
```

注意，部分字节数和比特位数只是一个示意值，主要表达一种设计意图。


### 询问包

```go
(4)     Ver：版本号。
(8)     ID： 标识本次询问，用于回复包中对应其源请求。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     跳数累计：上限值15，可以是非零起跳。
[4]     公钥算法：默认 X25519。
(32)    公钥数据：用于回复包加密联系信息。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     NAT 层级：
        1) `Pub/FullC`：可直连类型，包含通过 UPnP 直接映射到公网的。
        2) `RC`：受限圆锥型节点（Restricted Cone）。
        3) `P-RC`：端口受限圆锥型节点（Port Restricted Cone）。
        4) `Sym`：NAT对称型节点（Symmetric NAT）。
[4]     （未用）
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(4)     数据类别：
        主要用于区分不同数据采用的不同服务。
        0-0x1fff：
        系统保留区。
        1. 存档类：只是简单的检索获取。
        2. 区块链：提供相关信息服务，比如检索一笔交易或某个区块。
        ……
        0x2000-0xffffffff
        自由定制区。
        支持任意类型，由应用自行取值。可能为服务而非数据。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(n)     数据索引：
        通常为数据内容的哈希摘要，但也可由应用自由定义和解释（如含子类）。
        这与上面的数据类别相关联。
(4)     数据大小：
        按字节数计数，零值表示未知或忽略（如提供的是一个服务）。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

询问包为明文。但节点之间的通讯通常是加密的，避免第三方窥探。


### 转播包

驿站节点检查自身是否拥有目标数据，这根据询问包里的数据类别和数据索引来判断（也合称为数据ID）。

- **无：**
  标记该查询，将询问包内*跳数*加一后转播。如果跳数已到达上限，简单忽略。
- **有：**
  创建回复，回传给上级来源节点。
  可能需要检查NAT相互关系，若与询问者无法通讯，则视同没有数据，同上转播。

> **注：**
> 在询问包的转播扩散中，中转节点需要记住查询来源，因为回复包会按原路逆向返回。



## 2. 回复确认

如果节点拥有目标数据，构建回复包返回。返回会按询问包转播的原路径逆向回传。

原路回传可以让原本广播的信息逐级收缩，避免信息洪流的问题。同时这也是让询问者可以不必公开自己位置（IP）的技术条件。

如果驿站的数据源是受限节点 `RC|P-RC|Sym`（注：驿站的内部数据服务器可能是另一台主机），此时只能使用UDP协议，回复包会携带打洞需要的关联信息，如下：

- 自己连接的Findings公网节点（`IP:Port`）。
- 自己连接到Findings公网节点所使用的类别（`kind:name`）。
- 自己的NAT层级（`RC|P-RC|Sym`），可选。

> **提示：**
> 任何一方为`Sym`受限节点时，另一方必须为公网类（`Pub/FullC`）节点。
> 如果需要，驿站应确保数据源地址已在所指定的Findings节点上登记并当前有效。


### 回复包

```go
(4)     Ver：版本号。
(8)     询问ID：原询问包中的ID，用于上级对应请求源。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(32)    公钥数据：
        数据源的公钥，用于询问端构造共享密钥。算法与询问包相同，不再列出。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
注：以下信息会用共享密钥加密
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     跳数累计：
        询问包到达驿站时的跳数。加密避免被篡改，可用于请求源评估距离。
[4]     NAT 层级：
        数据源节点的一些信息，仅在采用UDP连接时提供。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(n)     - 协议：
          顶层封装名： websocket|dtls|tcp|udp。后两者指使用原始协议，很少用。
        - 数据源地址：
          与协议对应（IP:Port）。
        - 打洞协助：
          Findings节点地址、所使用类名（kind:name）。
          仅在采用UDP连接时需要。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

> **注意：**
> 如果采用的是普通的TCP或UDP协议，可能会被第三方监视。

在回复包的逆向回传路径上，每一层节点都会收到多个回复，但它们向上级续传时，只会发送一个回复包。出于安全性考虑，节点不应当只是简单返回最先收到的回复，然后丢弃剩下的回复，而是应当有一个策略：

1. 取最先返回的3个回复中的随机一个向上回传。
2. 设置某个时间长度，从第二个返回包开始计时，当时间到达时，随机选取已收到回复中的一个向上回传。
   这样，可以保证至少有2个候选者。
3. 当候选池中包含3个回复时，即可应用第一条规则。这样就可以避免继续等待。
4. 应当设置一个总的超时（比如5秒），超时后即便只有一个回复也回传。这样避免初始单数据上传时通常只有一个节点的问题。
   参考：高跳数请求的回复可以更及时一些。

> **理由：**
> 这样的策略可以避免*分布式数据阻断*攻击，即：
> 攻击者群体散布于网络中，对某个数据ID执行快速响应，但是它们实际上并没有该数据。
>
> 这一策略对初始单数据上传有一定影响，上传者可以通过多提供几个节点来缓解。


### 附：中转网

回复包中需要包含数据源的IP地址，以便询问者建立连接获取数据。但如果数据源不愿意暴露自己的地址，那该怎么办呢？

借鉴于Tor链路的中转思想，我们可以设计一个第三方应用：*数据中转服务网络*。这是一个通用的网络，客户端相互连接，提供数据中转服务。因为服务直接面对用户，所以它可以向用户提供自己的代币收益地址，就像普通的数据节点一样。

基本流程如下：

- 数据源连接中转网节点（A），向它请求一个远端节点（B）。同时提供一个随机的token标识（路径识别）。
- 数据源从数据网发送回复包，联系IP为中转网远端节点（B）的地址以及token标识。
- 询问者获知该远端节点地址并连接，同时发送回复包中携带的token标识。
- 远端节点（B）根据此token找到原请求节点（A），建立对应关系。传输路径：*数据源 <=> 中转节点A <=> 中转节点B <=> 询问者* 形成。
- 询问者从中转网络请求实际的数据。

> **注：**
> 数据源获取中转网远端节点时可以指定距离（跳数），这种联系实际上是透明的。
> 上面的示例里距离是**2**，如果指定距离为**1**，则数据的传输路径就类似于 `TURN` 服务了。

中转网实际上也可以帮助隐匿询问者，如果有节点希望探知是谁在查找某个数据，它很可能向询问者返回一个监听地址（冒充数据源地址），等候询问者的访问。

虽然这个监听地址不一定最终返回到用户节点（回传中被上层节点丢弃），但如果询问者想要隐藏自己，也可以向中转网节点请求转接。



## 3. 数据传输

### 获取信息

询问者收到回复后，用对方的公钥与自己的私钥构建共享密钥，解密回复包内的连系信息。

采用何种方式与数据源节点连接，有以下几种情况：

- 如果数据源为公网类节点（`Pub/FullC`）。通常会提供TCP协议的支持，询问者直接连接即可。
- 如果数据源为受限节点（`RC|P-RC|Sym`）。连系信息中包含打洞协助服务的信息，借助于Findings节点定向打洞服务即可。

> **注意：**
> 如果数据源为 `Sym` 受限类型，询问者自己必须是 `Pub/FullC` 级别才行。
> 这同样需要经过回复过程，而非数据源主动连接询问者，否则也有洪流攻击之虞。


### 传输数据

每个中转节点只会返回一个回复，因此询问者可能需要多创建一些与驿站节点的连接（而不是普通的8-10个），特别是对于大尺寸数据。

询问者与数据源节点沟通，如果是大尺寸数据，通常会先协商传输的数据格式（比如采用Torrent的分片方式），如果数据源支持，采用相同方式的节点间即可建立连接，询问者开始获得数据。



## 数据探测

**数据探测**是一种特殊的请求，主要用于完成数据的*紧缺性*感知。它的逻辑与询问有些相似，但无需实际的数据返回，甚至无需回复。

具体的节点行为：当节点收到探测消息后，检查探测的目标数据：**有则停止，无即转播**。与询问包相同，转播时跳数加一。无论有无目标数据，都无需回复。

作为探测包流经的驿站节点，根据目标数据的紧缺性情况，结合自身的存储策略，即可决定是否补充存储目标数据。


### 探测包

```go
(4)     Ver：版本号
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
[4]     跳数累计：上限值15，从零起跳（公约）。
[4]     签名算法：通用的几种之一。
(n)     签名公钥：与算法对应，可用于公认心跳节点的识别。
(n)     签名数据：对数据信息的签名结果。
        注：
        整个签名部分（算法+公钥+数据）为可选。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
注：以下也是签名的目标消息
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
(4)     数据类别：
        与查询包相同规范。
(n)     数据索引：
        通常为数据内容的哈希摘要，但也可由应用端自己定义和解释。
        与上面的数据类别相关。
(4)     数据大小：
        按字节计算的数据量，零值表示未知。可选。
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

探测包为明文，未加密，但可能有签名。

零起跳数是一个约定，破坏者可能籍此攻击网络，用初始高值来激发过度冗余。此时公认的守约探测者签名，可能是一个办法。

另外，一个存储者在决定补存某数据时，也可以先评估数据源的距离（跳数差），然后再决定是否真的创建连接，拉取数据。
