# 数据驿站（depots）设计

## 概要

『数据驿站』是数据网络中「数据」的临时集散地，P2P的驿站节点相互连接，组网成『数据网络』，对外提供数据的服务。

数据在驿站可能只是临时停留，也可能是长期存储。驿站通过数据的“紧缺性感知”机制，了解数据在全网的存在状态，结合自身的存储策略，决定是否存储目标数据。

对数据的**紧缺性感知**，是数据网络得以运行的关键，它辅助实现了数据信息在全网的沟通，为开放式的去中心化数据存储提供了前提。节点可根据目标数据的紧缺性，适时调整自己的存储集——如果它愿意的话。

> **提示：**
> 驿站提供的数据服务也可以不是数据，而是服务，此时在数据网络中请求的数据ID就只是一个入口标识。

驿站内部会集成不同类别的数据的服务，服务的收益地址通常由服务器自己发送。



## 数据查询

应用对自己需要的数据创建「询问」消息包，其中包含目标数据的唯一性标识，以及转发节点的起始跳数（可非零）。跳数将在每个转发节点间递增，以此表达数据的稀缺性。

应用向自身连接的驿站节点发送询问包，请求数据的查询。


### 检索

驿站解析询问包数据标识，获取数据类别和ID，按类别查询ID索引集。

- 如果目标不存在：
    1. 询问包跳数加一后即**转播**请求。
    2. 触发数据存储判断（参考跳数和自身存储策略）。
- 如果目标存在，向内部服务器寻求确认？
    - 存在：创建连系信息回复包响应。**注**：不再转播。
    - 没有：同上转播，以及触发补存判断。

> **设计：**
> 在驿站层面即设置索引集预判，可实现快速广播，优化效率。
> 索引集可能采用布隆过滤器，或其它效率更高的技术。


### 储备

如果目标数据没有储备，根据其紧缺性和存储策略需要存储时，驿站会发起请求。

内部的服务只负责数据的存储和检索，以及对外服务，数据网络的新逻辑会与之分离，这便于集成现有的数据库技术。



## 数据上传

无论有没有需求，一份网络上没有的新数据想要进入数据网络，就需要初始上传。


### 探测

客户端连网数据网络，向驿站节点发送一个该数据的**探测**包或询问包。

> **注：**
> 探测包是一个类似询问的简单请求，无需返回真实数据。


### 上传

这个探测（或询问）会触发驿站的数据存储判断。

因为网络还没有该数据，所以紧缺性极高，这通常会触发部分驿站主动请求该数据。由此，数据拥有者即可充当数据源节点，上传数据。

这是一种没有特定用户的主动上传，或许可称之为**无驱动**上传。


### 优点

与流行的*IPFS*不同，这里不需要预先存在某个特定用户的拉取，数据的保留更容易。同时也与*Arweave*有区别，这里数据无需上链，因此数据的大小不受限制。

> **注：**
> 数据网络为区块链提供服务，是区块链的底层支持系统，接受其代币回报。


### 附：分片存储

对于超大尺寸数据，节点可能采用分片存储。在这里，每个分片视为一个独立的文档。对它们的检索也是各自独立的。



## 数据服务

### 文档存储

作为一种最基本需求，档案存储可适用于任意数据的**保留**。这应该是一个基础性服务。

本服务没有太多的功能，只是简单的存档和提供数据。数据ID为内容或分片的哈希摘要（采用 `SHA3:256` 算法）。

详细内容参考 [github.com/cxio/archives](https://github.com/cxio/archives) 项目。


### 区块查询

本服务与档案存储类似，也是数据网络的基础性服务，因为数据网络的运行就基于区块链代币的激励能力。

区块查询有其自身的特点，需要提供尽可能高的性能，因此一个普通的驿站可能仅仅只提供少数甚至某一单一区块链的查询。


#### 索引结构

数据索引包含内部结构：`[blockchain-name]:[data]`。

其中 `blockchain-name` 为区块链的名称（如 `Bitcoin`），后面的 `data` 为数据ID本身，由该区块链自己所属的检索函数处理，两者以分号（`:`）分隔。这是一种固定格式，以包含任意的区块链类型。

> **注意：**
> 区块链名称和数据由冒号（:）分隔，因此区块链名本身不能包含冒号。

详细内容参考 [github.com/cxio/blockqs](https://github.com/cxio/blockqs) 项目。


### 其它服务

驿站内支持的服务是一个泛化的逻辑。即它可以支持任意的服务，只需要在数据类别中标识即可。其数据索引也由服务自己解释，并无统一的规范要求。

仅仅通过数据类别来区分不同的服务并不严谨，但这是**泛化**的代价。
