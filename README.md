# 数据驿站服务（depots）

## 前言

在传统的P2P网络里，相同应用的节点间相互连接，交互彼此需要或拥有的数据，不同应用之间是隔离的（即便操作的是同一份数据）。数据驿站服务试图在不同的应用系统之间抽象出统一的接口，专门操作数据本身，最大限度地剥离应用的负载，同时也提高效率。

实际上，这样的数据服务可以成为P2P网络的通用数据层，如果把网络比喻为一台计算机，这一数据层就类似于文件系统的服务。

数据驿站是一个「壳」，管理数据在全网的流通和缓存，内部由具体的微服务实际操作数据（如：archives、blockqs）。基本上，这可以理解为一个内含数据仓库或处理器的数据中转站，数据是变动的：增加、减少、选择性存储、或特定的处理等。

数据驿站之间相互连接组网，构成一个P2P的数据流动层，从而支持开放的数据存储模式。


## 全网数据紧缺性感知的机制

P2P网络节点对数据的请求是通过广播查询，没有目标数据的节点会转播请求，拥有数据的节点则回应而不再转播。如果设计请求每转播一次就跳数加一（最大值15），则通过跳数的大小，节点就可以感知请求广播的距离，距离越远说明数据越紧缺，这可以促使节点补充存储紧缺的数据。

驿站之间相互协作共同存储，通过数据的紧缺性感知进行自愿冗余弥补，但这种自愿存储无法保证数据的完备性。虽然对数据需求的利益驱动可以缓解这一问题，但仍不足够，我们需要一些公益性的稀有数据保全节点来补充保障。

这是P2P逻辑下一种模糊的全网存储协调机制，没有绝对的保证但或许冗余性足够，主要是简单易行。


### 数据心跳：完整感知的保障

数据的紧缺性感知并不完全可靠。有些数据的用户很少或使用率很低，这样对这些数据的请求会很少，它们可能被慢慢遗忘，在长期的存储中被清理出去，最后丢失。因此我们需要一个方法来保证它们的存在性感知，这就是数据心跳。

数据心跳是一个形象的比喻，它实际上是由节点持续发出的数据探测。探测不是真实的数据请求，只是包含了一个标记说明的数据查询：拥有数据的节点无需回应，没有数据的节点正常转播。于是数据的紧缺性又可以被察觉了。

执行数据探测的通常是一些公益性节点，因为数据索引（ID）都已存在于区块链上，所以节点按索引间断发出探测请求即可。这些探测节点被称为心跳节点，理论上应该在地理位置上均衡分布，也不需要太多。


### 附：数据ID与服务标识

数据ID是数据的哈希摘要，用于唯一地标识一个数据，但事实上，请求标识可以不止是数据ID，它还可以是服务ID。如果采用随机的序列表达服务标识（客户机查询该标识建立联系获得服务），在外观上它就与数据ID没有区别，除了提供服务者和参与其中的节点，没人知道那个ID表示什么。

传统的**客户机/服务器**网络通过域名寻址查找和提供服务，这里的P2P环境下则是以随机的标识，通过P2P询问获取或创建服务。显然，这种方式在隐秘性、灵活性甚至扩展性方面有很大的优势。


## 数据站群

数据驿站不必是一个实体的概念，如果允许任意数据服务节点声明同一个收益公钥（地址），实际上这就创建出一个虚拟的「数据驿站」了。因为声明共同的收益地址，所以这个地址被认可的范围会更广，这会提什兑奖的确认数（提升兑奖的比例）。

这是一种可以汇聚零散节点小量数据服务的机制，有点类似于Bitcoin系统中矿池的作用。


### 开放评估

数据站群的管理者需要评估成员节点的服务绩效，为奖励的分发提供依据。因为数据服务是端对端的，服务节点直接给客户（请求者）提供数据，所以嵌入第三方的管理职能会是一个问题。通常的做法可能是设计一个专用的客户端，包含了数据的传输检测、统计、成员认证等功能，但这样的解决方案并不通用，而且客户端有被破解作弊的潜在隐患。

是否有更简单的解决办法呢？下面是系统默认提供的评估机制。


#### 协议补充

数据服务节点在提供数据给对方的同时，需要向对方公布收益公钥（地址），以此来接收区块链节点的代币奖励。这里，我们增加一个可选的字段：服务节点还可以向对方公布一个**身份ID**（通常也是一个公钥地址）。

身份ID的用途是服务节点在站群中标注自己，这样站群的管理者就可以向自己发送奖励。这个字段是可选的，如果节点不属于任何站群（譬如一个中心化实体驿站的节点），那就可以简单地将这个字段置空。

这是一个很小的代价（32字节的额外网络流量）。


#### 匿名探测

不需要任何**管理**措施，管理者可以像普通客户一样向网络请求数据。但与普通客户不同的是，管理者并不是要请求完整的数据本身，而是随机的分片数据（不同实体数据的不同分片）。分片数据用于验证服务的真实性，随机性用于保证公平，同时也会接收并处理身份ID的信息（普通客户只是简单地忽略它）。

基本操作：如果服务节点公布的收益地址与本群的收益地址相同，该节点就是本站群的成员，记录其身份ID，给予一个评优积分。

在这里，服务节点没法作弊，因为它不知道何时可以撒谎（告知管理者正确的收益地址，但实际服务时却公布其它的收益地址）。因为任何时候对方都可能是管理者，而一旦错过了提供正确地址的评优机会，损失就是很大的。

> **注记：**<br>
> 一个简单的优化可能是匿名探测与专用App结合：App只需告诉管理者自己的IP地址，这样就可以大幅缩小管理者的探测范围从而提高效率。


#### 开放性

数据站群的信息是公开的，因为这样才能吸引离散的自由节点加入。站群的收益地址被公众所知道，而通过匿名探测的方式，实际上开放的监督可以自然出现：任何人都可以探测一个收益地址（站群）的成员有哪些，以及具体的详细情形（与管理者的能力没有区别）。虽然基于概率的原因会有一些误差，但基本上可以评估这些收益地址的奖励分发是否基本合理。

拥有开放的监督的机制，自由节点用脚投票的市场压力就有效。这可以约束站群管理者的行为。


### 随机缓存

敏感的数据可能被屏蔽，小众的数据可能遗失，在这里统称为「数据歧视」。

因为小节点也可以借助于虚拟数据驿站参与数据服务，所以局部数据存储是有现实驱动力的。从全网整体上的合理存储分布来说，这些局部数据应当是随机的才好。从最小规模的层面上看，我们希望实现一个随机缓存的模式，即：即便节点不实施固态存储，中转节点依然应当参考数据紧缺性，请求随机的数据片段实施内存缓存。

这样的缓存不只是提供一点获利的机会（或许吸引力并不大），其实更重要的是，它可以极大地消减数据歧视的范围和程度，而这是很重要的。


#### 附：数据源的隐匿性

保护数据的来源不易被探查，有一个简单的方法就是中介跳转。`Tor` 中通过至少两个中间节点的转播来强化匿名性，但这种方式有失效率。

仅就数据获取来说，如果数据随处可及但它们并没有确定的主人，实际上就可以保护真正的主人。而对于数据用户，随手可及的数据也可以强化非零（随机）起跳数的效用（或者法不责众）。


## 无效数据

存储基于区块链上交易里的附件ID（索引），不在区块链上标识的数据是无效的。

对于一个普通的数据服务节点来说，分辨数据是否有效是困难的，因为这必须集成相关的区块链数据或能力。但如果不去分辨，就会给攻击者以机会（发送大量无效ID的请求试图引发链式反应）。解决的办法可以尝试如下：

1. 发送数据心跳的节点加入签名验证，权威的节点可以获得公认的认可。
2. 对于跳数过高的请求，可以保持转发但不一定实施补充存储。这样，请求会因跳数达到上限而自然消失，同时也不会有新的数据请求拥挤网络。
